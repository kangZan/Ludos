# Ludos — 角色驱动叙事推演智能体

基于 LangGraph 的多智能体叙事推演系统，用于小说创作辅助。

English version: [README_EN.md](README_EN.md)

## 核心特性

- **角色自主驱动**：角色基于自身档案独立决策，而非作者预设剧情
- **认知红绿灯**：严格的信息隔离机制，确保角色只能使用自身已知信息
- **秘密压力系统**：秘密在自然对话中有机暴露，而非机械触发
- **非数值化冲突**：文学化定性描述替代数值化判定
- **三阶段架构**：初始化 → 自主推演循环 → 文学润色

## 快速开始

### 环境准备

```bash
# 创建 conda 环境
conda create -n ludos python=3.12 -y
conda activate ludos

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
# 编辑 .env，填入你的 LLM API Key
```

### 健康检查

```bash
# 基础健康检查（含 LLM 连通性）
python -m src.main --health

# 启动脚本健康检查
python scripts/run.py --health
```

### 插件化工具注册

通过环境变量 `TOOL_PLUGINS` 以逗号分隔指定模块路径，模块导入时需注册工具。

示例：
```bash
export TOOL_PLUGINS=plugins.tools.extra,plugins.tools.more
```

插件模块中注册工具：
```python
from src.tools.registry import register_tool

def my_tool(x: str) -> str:
    return x.upper()

register_tool("my_tool", my_tool)
```

### 运行

```bash
# 从文件输入
python -m src.main input.txt --output result.md

# 从标准输入
echo "你的叙事纲要..." | python -m src.main

# 使用启动脚本（含环境检查）
python scripts/run.py input.txt
```

### 运行中日志与角色记忆

运行时会生成两类日志：

- 公共广播日志：`logs/session_<id>.public.log`
- 原始交互日志：`logs/session_<id>.raw.log`

可实时查看公共广播日志：

```bash
tail -f logs/session_<id>.public.log
```

每个角色会维护自己的记忆文件（半结构化协议）：

```
data/characters/<session_id>/<角色ID>.mem.txt
```

### 示例（节选：session `3cbd2932`）

> 目的：展示 “输入 → 过程文档 → 输出” 的最小闭环。以下均为节选片段，非完整内容。

输入（叙事纲要文件，略）：

过程文档（公共日志，节选，来自 `logs/session_3cbd2932.public.log`）：
```text
[场景：**时间：** 无明确时间标识，空间内弥漫的灰雾未呈现昼夜变化，时间流速难以感知。 ...]
[角色-王信球（上首身影）] [说话] "“此处的访客，欢迎你们。你们的祈祷……已在此处得到响应。”"
[角色-李梓萌（右侧下首身影）] [说话] "（声音尽量保持平稳，但带着一丝不易察觉的激动与敬畏）伟大的存在，感谢您的响应与接纳。..."
```

过程文档（原始交互日志，节选，来自 `result.md` 的“原始交互日志”部分）：
```text
[场景：时间：感知不明，无昼夜变化。地点：无垠灰雾中的古老宫殿内部。中央的青铜长桌与高背椅构成场景焦点。...]
[角色-王信球（上首身影）] [动作] 维持端坐的姿态，被灰雾包裹的轮廓似乎更加稳定、凝实了一些。... [说话] "“此处的访客，欢迎你们。你们的祈祷……已在此处得到响应。”"
[角色-李梓萌（右侧下首身影）] [动作] 身体在椅子上微微前倾，做出一个恭敬倾听的姿态... [说话] "（声音尽量保持平稳，但带着一丝不易察觉的激动与敬畏）伟大的存在，感谢您的响应与接纳。..."
```

过程文档（角色记忆，节选，来自 `data/characters/3cbd2932/李梓萌（右侧下首身影）.mem.txt`）：
```text
[GOALS]
李梓萌（右侧下首身影）_goal_0|active|向上首身影表达恰当的敬意与感激之情，试探性地询问此次会面的缘由或目的，以确认其安全性。
李梓萌（右侧下首身影）_goal_1|active|优雅地介绍自己（可隐去真名但表明身份阶层），并含蓄地表达对神秘知识的渴求，观察“主宰者”的反应。

[STABLE]
身份：一名对神秘世界充满向往但苦无门路的贵族少女。我正在进行的冥想似乎引来了超乎想象的回应。
私人理解：灰雾、古老宫殿、神秘的青铜桌……这和我读过的隐秘典籍描述的场景如此相似！
```

输出（润色叙事文本，节选，来自 `result.md`）：
```text
无垠的灰雾如亘古的帷幕，笼罩着寂静的宫殿。稀薄的雾气在空气中缓缓流转，恒定不变，仿佛时间在此失去了刻度。
宫殿中央，青铜长桌与高背椅是这片混沌中唯一确切的焦点。
桌面上，古老而繁复的纹路镌刻其中，持续散发着非自然的、微弱的光晕，像沉睡巨兽皮肤下缓慢流淌的血液。
```

### 测试

```bash
pytest tests/ -v
pytest tests/ --cov=src --cov-report=term-missing
```

## 架构概览

```
用户输入（叙事纲要）
        ↓
  [初始化] 解析为结构化JSON → 角色记忆 seed
        ↓
  [推演循环] 场景播报 → 角色逐个行动 → 压力更新 → 回合评估（角色自评）
        ↓  (循环直到结束条件满足)
  [润色] 原始日志文件 → 文学叙事文本
        ↓
  输出：原始交互日志 + 润色叙事文本
```

### 公共/私有记忆数据流示意

```
           ┌──────────────────────────────┐
           │          主持人 (Moderator)  │
           │  - 场景播报                  │
           │  - 公共交互日志               │
           │  - 公共记忆维护               │
           └───────────────┬──────────────┘
                           │ 公共广播
                           ▼
┌───────────────────────────────────────────────────────────┐
│                    公共日志 (public.log)                  │
└───────────────┬───────────────────────────────────────────┘
                │ 仅新增部分
                ▼
┌──────────────────────────────┐    ┌──────────────────────────────┐
│ 角色A 私有记忆 (mem.txt)       │    │ 角色B 私有记忆 (mem.txt)       │
│ - 稳定记忆                    │    │ - 稳定记忆                    │
│ - 工作记忆                    │    │ - 工作记忆                    │
│ - 目标/秘密/压力              │    │ - 目标/秘密/压力              │
└───────────────┬──────────────┘    └───────────────┬──────────────┘
                │                                   │
                └──────────────┬────────────────────┘
                               ▼
                       角色对外交互输出
                               │
                               ▼
                      主持人转发并同步公共信息
```

## 项目结构

```
src/
├── config/     # 配置管理与提示词模板
├── models/     # 领域类型与Pydantic模型
├── agents/     # 智能体（主持人/角色/润色）
├── graphs/     # LangGraph图定义
├── tools/      # 工具集（信息过滤/压力追踪等）
├── memory/     # 持久化模块
└── utils/      # 工具函数
```

## 文档

- [架构设计](doc/v0.1.0/design.md)
- [API文档](doc/v0.1.0/api.md)
- [变更日志](doc/v0.1.0/changelog.md)
- [并行决策优化计划](doc/v0.1.0/并行决策优化计划.md)
- [世界观分层与可获得性方案](doc/v0.1.0/world_knowledge_plan.md)

## 许可证

MIT

## 改造记录

已完成：
- 角色记忆半结构化协议（无 JSON 解析依赖）
- 主持人仅维护公共广播与公开交互日志
- 原始交互日志运行时落盘并用于润色
- 角色自管目标状态与秘密压力值（从全局 state 中剥离）
- 主持人评估仅基于公共日志汇总，不读取角色私有记忆

下一步计划：
1. 并行决策优化（并行意图收集 → 主持人裁决 → 失败通知），详见 `doc/v0.1.0/并行决策优化计划.md`。
1. 新增世界观档案与角色社会/战斗档案：世界观分层（COMMON/REGIONAL/SPECIAL/SECRET），角色按 `knowledge_level` 读取，避免世界背景泄露。
1. 角色对外交互新增“小动作”字段，用于记录角色为达成目标的细微动作。
2. 主持人维护小动作记忆，并在后续根据情境判定是否被其他角色发现。
3. 该机制复杂度较高，暂以计划形式记录，后续逐步实现。
