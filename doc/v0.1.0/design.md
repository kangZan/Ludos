# Ludos v0.1.0 架构设计文档

## 系统概述

Ludos 是一个基于 LangGraph 的多智能体叙事推演系统，用于小说创作辅助。系统通过模拟角色在给定剧本框架下的自主交互，生成逼真的角色对话和逻辑自洽的情节发展。

## 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    顶层编排图 (Orchestrator)               │
│                                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │          阶段一：初始化 (Initialization)            │   │
│  │  parse_outline → validate → distribute_dossiers  │   │
│  │                    ↓                              │   │
│  │             [人工审核档案]                          │   │
│  └──────────────────────────────────────────────────┘   │
│                         ↓                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │       阶段二：自主推演循环 (Deduction Loop)         │   │
│  │                                                    │   │
│  │  announce_scene → determine_turn_order             │   │
│  │       ↓                                            │   │
│  │  character_turn ←──── (循环: 逐角色行动)            │   │
│  │       ↓                                            │   │
│  │  update_pressures → assess_round → check_end      │   │
│  │       ↓                              ↓             │   │
│  │  (继续下一轮)                    (结束 → 阶段三)    │   │
│  └──────────────────────────────────────────────────┘   │
│                         ↓                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │           阶段三：润色 (Polishing)                  │   │
│  │  prepare_raw_log → literary_polish → quality_check│   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## 公共/私有记忆数据流示意

```
           ┌──────────────────────────────┐
           │          主持人 (Moderator)  │
           │  - 场景播报                  │
           │  - 公共交互日志               │
           │  - 公共记忆维护               │
           └───────────────┬──────────────┘
                           │ 公共广播
                           ▼
┌───────────────────────────────────────────────────────────┐
│                    公共日志 (public.log)                  │
└───────────────┬───────────────────────────────────────────┘
                │ 仅新增部分
                ▼
┌──────────────────────────────┐    ┌──────────────────────────────┐
│ 角色A 私有记忆 (mem.txt)       │    │ 角色B 私有记忆 (mem.txt)       │
│ - 稳定记忆                    │    │ - 稳定记忆                    │
│ - 工作记忆                    │    │ - 工作记忆                    │
│ - 目标/秘密/压力              │    │ - 目标/秘密/压力              │
└───────────────┬──────────────┘    └───────────────┬──────────────┘
                │                                   │
                └──────────────┬────────────────────┘
                               ▼
                       角色对外交互输出
                               │
                               ▼
                      主持人转发并同步公共信息
```

## 核心组件

### 1. 主持人智能体 (Moderator)
- 负责场景播报、回合顺序决定、客观记录、回合评估
- 只维护公共记忆（公共广播与公开交互日志）
- 转发角色对外交互，向所有在场角色同步公共信息
- 绝不判定行动成败，仅客观记录

### 2. 角色智能体 (Character)
- 基于角色档案、场景状态、交互历史进行自主决策
- 输出复合行动包（说话/动作/复合 + 内心想法）
- 受认知红绿灯机制约束，只能使用自身已知信息
- 自主管理私有记忆（私有信息、目标状态、秘密压力）
- 对外交互由角色自主生成并由主持人转发

### 3. 润色智能体 (Polisher)
- 将原始交互日志转化为文学叙事文本
- 添加氛围、神态、内心独白、文学化冲突描述

## 关键机制

### 认知红绿灯（三层防御）
1. 结构过滤层：构建角色上下文时过滤不可见信息
2. 提示词约束层：明确告知角色只能使用已知信息
3. 事后验证层：检测输出中的信息泄露并重试

### 秘密压力值系统
- 关键词匹配 → 压力累积
- 达到阈值 → 注入"说漏嘴"警告
- 角色自主决定是否暴露

### 状态管理
- 使用 LangGraph StateGraph + TypedDict
- Annotated reducer 用于累积交互日志
- Checkpointer 实现状态持久化

## 技术栈
- Python 3.12.x
- LangGraph 0.3+
- LangChain Core / OpenAI
- Pydantic 2.0+
- structlog

## 插件化工具架构

系统提供简单的工具插件机制，允许通过环境变量动态加载自定义工具。

### 插件加载

通过环境变量 `TOOL_PLUGINS` 指定逗号分隔的模块路径。运行时会在启动时导入这些模块。

示例：
```
TOOL_PLUGINS=plugins.tools.extra,plugins.tools.more
```

模块被导入时应调用注册函数，将工具加入注册表。

### 插件注册协议

插件模块需调用 `register_tool` 注册工具函数：

```python
from src.tools.registry import register_tool

def my_tool(x: str) -> str:
    return x.upper()

register_tool("my_tool", my_tool)
```

### 设计目的

- 支持自定义工具的动态扩展
- 避免修改核心代码即可新增功能
- 为后续更复杂的插件体系预留入口

## 下一步计划（提案）

### 角色小动作记录机制

目标：在角色对外交互中引入“小动作”字段，用于记录角色为达成目标采取的细微动作（如偷偷观察、隐藏物品、微表情变化等），由主持人维护并在后续根据情境判定是否被其他角色察觉。

规划：
- 角色输出新增“小动作”字段（单条或数组）
- 主持人维护“小动作记忆”并按场景判断是否公开
- 该机制复杂度较高，暂作为计划项记录，后续迭代实现
