# Ludos v0.1.0 并行决策优化计划（下一版本）

> 目标：提升叙事公平性与因果一致性，优先保证准确性，其次考虑成本，速度优先级最低。

---

## 1. 背景与问题

当前推演为严格串行：
- 后行动角色天然占信息优势
- 无法表达“同时行动”
- 角色数增加导致线性延迟与成本

本优化引入“并行意图 + 主持人裁决 + 仅失败通知”的机制，使角色心理上仍感知“串行因果”，但实质并行决策。

---

## 2. 核心目标（优先级）

1. **准确性**：避免角色看到彼此意图，保证因果一致性  
2. **成本可控**：减少不必要的 LLM 输出  
3. **速度**：可牺牲，非优先

---

## 3. 方案概述

### 3.1 新的回合流程

1. 公共信息广播（统一起点）  
2. 角色并行生成 `ActionIntent`（只意图，不含结果）  
3. 主持人检测冲突并裁决  
4. 仅通知被打断角色  
5. 仅记录生效动作到公共日志  

### 3.2 关键原则

- 默认“成功”，只有被打断才会收到通知  
- 公共日志不记录失败意图  
- 裁决逻辑由主持人统一执行  

---

## 4. 数据结构最小改动建议

### 4.1 ActionIntent（新增）

- `actor_id`: 角色 ID  
- `intent_summary`: 一句话意图描述  
- `target_ids`: 目标角色或对象列表（可为空）  
- `intent_type`: 互动/移动/调查/阻止/撤退（枚举）  
- `risk_level`: low/med/high（可选）  

### 4.2 ConflictResult（新增）

- `resolved_actions`: 生效动作列表  
- `interrupted`: 被打断列表（角色 ID + 理由）  

---

## 5. 冲突检测与裁决（最简规则）

- **同一目标**：按主持人裁决优先级排序  
- **互相阻断**：选择一个生效，另一个被打断  
- **强制轮转**：若同一角色连续多回合压制他人，触发优先级下降  

> 轮转机制是可选策略，默认只在连续 2 回合出现“同一方胜出”时触发一次修正。

---

## 6. 成本优化策略

### 6.1 两阶段生成（可选）

1. 所有角色先输出 `ActionIntent`  
2. 仅生效者再生成完整 `ActionPack`  

### 6.2 失败者通知最小化

失败通知仅包含：
- 被打断原因（简述）  
- 可接受的替代解释（如“被抢先”或“对方先一步达成”）

---

## 7. 兼容性与回滚策略

- 保留现有串行模式作为 fallback  
- 新模式以配置开关启用：`decision_mode = "parallel"`  
- 若裁决失败或意图无法解析，则回退串行

---

## 8. 实施步骤（建议顺序）

1. 新增 `ActionIntent` 解析与校验  
2. 增加“并行意图收集”节点  
3. 增加“冲突裁决”节点  
4. 增加“失败通知”流程  
5. 公共日志改为仅写入生效动作  
6. 增加最小测试覆盖（冲突检测/裁决/通知）

---

## 9. 验收标准

1. 并行模式下角色无法读到彼此意图  
2. 同一目标冲突下只有一方生效  
3. 被打断角色收到明确原因  
4. 公共日志仅包含生效动作  
5. 串行模式仍可正常运行
